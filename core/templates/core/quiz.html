{% extends 'base.html' %}
{% block nav %}{% endblock %}
{% block content %}
{% load quiz_extras %}

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow p-4" style="border-radius: 20px;">
        <div class="mb-3 text-center">
          <h4 class="fw-bold mb-1" style="letter-spacing: 1px;">
            ðŸ“¹ Video {{ video_position }} of {{ video_total }} â€“ <span style="color: #4f8cff;">{{ video.title }}</span>
          </h4>
        </div>
        <div class="mb-4 text-center">
          <video width="100%" height="360" controls style="border-radius: 12px; box-shadow: 0 2px 12px #0001;">
            <source src="{{ video.video_file.url }}" type="video/mp4">
            Your browser does not support HTML video.
          </video>
        </div>
        <div class="mb-2 text-end">
          <span class="badge bg-warning text-dark">
            Time left: <span id="timer">{{ remaining }}</span> seconds
          </span>
        </div>
        <div class="mb-3">
          <div class="d-flex align-items-center justify-content-between" style="gap: 1rem;">
            <span class="text-muted small">
              Progress: Question {{ q_index|add:1 }} of {{ total_questions }}
            </span>
          </div>
          <progress value="{{ q_index|add:1 }}" max="{{ total_questions }}" style="width: 100%; height: 16px; margin-top: 8px;"></progress>
        </div>
        <!-- Alert for no answer selected -->
        <div id="answer-alert" class="alert alert-danger d-none" role="alert">
          Please select an answer before submitting!
        </div>
        <form id="quiz-form" method="post">
          {% csrf_token %}
          <div class="mb-4">
            <h5 class="fw-bold mb-3" style="font-size: 1.25rem;">{{ question.text_raw }}</h5>
            {% if question.hint %}
              <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#hintBox">
                <span class="badge bg-info text-dark">Show Hint</span>
              </button>
              <div class="collapse mt-2" id="hintBox">
                <div class="alert alert-info">{{ question.hint }}</div>
              </div>
            {% endif %}
            {% for answer in answers %}
              <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="selected_answer" value="{{ answer.id }}" id="answer{{ answer.id }}"
                  {% if progress.answers|get_item:question.id == answer.id %}checked{% endif %}>
                <label class="form-check-label" for="answer{{ answer.id }}" style="font-size: 1.1rem;">
                  {{ answer.text }}
                </label>
              </div>
            {% endfor %}
          </div>
          <input type="hidden" name="video_id" value="{{ video.id }}">
          <input type="hidden" name="question_id" value="{{ question.id }}">
          <input type="hidden" id="q_index" name="q_index" value="{{ q_index }}">
          <div class="d-flex justify-content-between align-items-center mt-4" style="gap: 0.5rem;">
            <button type="submit" name="prev-btn" id="prev-btn" class="btn btn-outline-secondary px-4" style="border-radius: 10px;" {% if prev_index is None %}disabled{% endif %}>
              &#8592; Previous
            </button>
            <button type="submit" name="next-btn" id="next-btn" class="btn btn-primary px-4" style="border-radius: 10px;" {% if next_index is None %}disabled{% endif %}>
              Next &#8594;
            </button>
            <button type="submit" name="submit-btn" id="submit-btn" class="btn btn-success px-4" style="border-radius: 10px;" {% if next_index is not None %}disabled{% endif %}>
              <span style="font-size: 1.1rem;">&#10004;</span> Submit
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Timer logic
  let timeLeft = parseInt("{{ remaining|default:0 }}");
  let timerElement = document.getElementById('timer');
  let interval = setInterval(() => {
    if (timeLeft <= 0) {
      clearInterval(interval);
      document.getElementById('quiz-form').submit(); // Auto-submit on timeout
    } else {
      timerElement.textContent = timeLeft;
      timeLeft--;
    }
  }, 1000);

  // Enable submit button if an answer is already selected on page load
  window.addEventListener('DOMContentLoaded', function() {
    let submitBtn = document.getElementById('submit-btn');
    let radios = document.querySelectorAll('input[name="selected_answer"]');
    let anyChecked = document.querySelector('input[name="selected_answer"]:checked');
    submitBtn.disabled = !anyChecked && submitBtn.disabled;
    radios.forEach(function(radio) {
      radio.addEventListener('change', function() {
        submitBtn.disabled = false;
      });
    });
  });

  // Prevent form submit if no answer is selected
  document.getElementById('quiz-form').addEventListener('submit', function(e) {
    let checked = document.querySelector('input[name="selected_answer"]:checked');
    let alertBox = document.getElementById('answer-alert');
    if (!checked) {
      e.preventDefault();
      alertBox.classList.remove('d-none');
      alertBox.scrollIntoView({behavior: "smooth", block: "center"});
    } else {
      alertBox.classList.add('d-none');
    }
  });

document.getElementById('quiz-form').addEventListener('submit', function(e) {
  // Only validate if the user is clicking Next or Submit (not Previous)
  let activeElement = document.activeElement;
  let isPrev = activeElement && activeElement.name === "prev-btn";
  if (isPrev) return; // Allow going back without answering

  let checked = document.querySelector('input[name="selected_answer"]:checked');
  let alertBox = document.getElementById('answer-alert');
  if (!checked) {
    e.preventDefault();
    alertBox.classList.remove('d-none');
    alertBox.scrollIntoView({behavior: "smooth", block: "center"});
  } else {
    alertBox.classList.add('d-none');
  }
});


</script>
{% endblock %}